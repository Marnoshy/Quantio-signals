//@version=5
indicator("Quantio V7 - TRUE NO REPAINT", overlay=true, max_lines_count=500, max_labels_count=500, max_boxes_count=500, dynamic_requests=true)

// ============================================
// V7 - TRUE NO REPAINT SYSTEM - FINAL FIX
// Lines stop EXACTLY at exit and PERSIST forever
// ============================================

// === COLORS ===
c_buy_main       = #00897B
c_sell_main      = #E53935
c_signal_bar     = #2962FF
c_text_dark      = #131722
c_win            = #00C853
c_loss           = #B0BEC5
c_candle_neutral = #787B86

// === INPUTS ===
lookback_length = 10
x = 25
signal_label_size = size.small
atr_len_input = 14
atr_offset_mult = 0.5
show_line_fill_active = true
persistent_line_width = 1
enable_grey_candles = input.bool(true, title="Grey Candles on Neutral", group="Visual Settings")
filter_lookback = 5
backtesting_mode = input.bool(false, title="Backtesting Mode", group="Performance")
enable_htf_supertrend = true
htf_multiplier = 2
supertrend_period = 10
supertrend_multiplier = 3
signal_filter = input.string("All Signals", title="Signal Filter", options=["All Signals", "BUY Only", "SELL Only"], group="Visual Settings")

// === RSI ===
rsi_length = 14
rsi_value = ta.rsi(close, rsi_length)
crossover_30 = ta.crossover(rsi_value, 30)
crossover_70 = ta.crossunder(rsi_value, 70)

// === FRACTALS (using confirmed data only) ===
up_fractal = high[3] == ta.highest(high[1], 5) and high[3] > high[2] and high[3] > high[4] and high[3] > high[1] and high[3] > high[5]
down_fractal = low[3] == ta.lowest(low[1], 5) and low[3] < low[2] and low[3] < low[4] and low[3] < low[1] and low[3] < low[5]

var float last_up_fractal_high = na
var int last_up_fractal_index = na
var float last_down_fractal_low = na
var int last_down_fractal_index = na

if up_fractal and barstate.isconfirmed
    last_up_fractal_high := high[3]
    last_up_fractal_index := bar_index - 3

if down_fractal and barstate.isconfirmed
    last_down_fractal_low := low[3]
    last_down_fractal_index := bar_index - 3

// === HIGH/LOW LOGIC ===
lowest_low = ta.lowest(low[1], lookback_length)
highest_high = ta.highest(high[1], lookback_length)

var int lowest_low_bar = na
var int highest_high_bar = na

for i = 1 to lookback_length
    if low[i] == lowest_low
        lowest_low_bar := bar_index - i
        break

for i = 1 to lookback_length
    if high[i] == highest_high
        highest_high_bar := bar_index - i
        break

// Calculate levels
var float buy_fractal_level = na
var float sell_fractal_level = na

if not na(lowest_low_bar) and not na(last_up_fractal_index)
    if last_up_fractal_index < lowest_low_bar
        buy_fractal_level := last_up_fractal_high

if not na(highest_high_bar) and not na(last_down_fractal_index)
    if last_down_fractal_index < highest_high_bar
        sell_fractal_level := last_down_fractal_low

// === RSI RECENCY ===
recent_cross_30 = false
recent_cross_70 = false

for i = 1 to 20
    if crossover_30[i]
        recent_cross_30 := true
        break

for i = 1 to 20
    if crossover_70[i]
        recent_cross_70 := true
        break

// === HTF SUPERTREND ===
f_get_htf_tf(mult) =>
    mins = timeframe.in_seconds() / 60 * mult
    mins < 60 ? str.tostring(math.round(mins)) : mins < 1440 ? str.tostring(math.round(mins/60)) : mins < 10080 ? str.tostring(math.round(mins/1440)) + "D" : mins < 43200 ? str.tostring(math.round(mins/10080)) + "W" : str.tostring(math.round(mins/43200)) + "M"

htf_tf = f_get_htf_tf(htf_multiplier)

f_supertrend(factor, period) =>
    atr_v = ta.atr(period)
    up = hl2 + factor * atr_v
    dn = hl2 - factor * atr_v
    var float st = na
    var int dir = 1
    prev_st = nz(st[1], dn)
    prev_dir = nz(dir[1], 1)
    if na(atr_v[1])
        dir := 1
        st := dn
    else
        st := prev_dir == 1 ? math.max(dn, prev_st) : math.min(up, prev_st)
        dir := close > st ? 1 : -1
        if dir != prev_dir
            st := dir == 1 ? dn : up
    [st, dir]

[htf_st, htf_dir] = request.security(syminfo.tickerid, htf_tf, f_supertrend(supertrend_multiplier, supertrend_period), lookahead=barmerge.lookahead_off)

htf_buy_ok = not enable_htf_supertrend or htf_dir == 1
htf_sell_ok = not enable_htf_supertrend or htf_dir == -1

buy_allowed = signal_filter == "All Signals" or signal_filter == "BUY Only"
sell_allowed = signal_filter == "All Signals" or signal_filter == "SELL Only"

// ============================================
// PERMANENT TRADE STATE STORAGE
// ============================================
var bool is_buy_active = false
var bool is_sell_active = false
var bool signal_lock = false

// Stored trade parameters
var float stored_buy_entry = na
var float stored_buy_sl = na
var float stored_buy_tp1 = na
var float stored_buy_tp2 = na
var int stored_buy_bar = na
var float stored_buy_low_for_label = na
var int stored_buy_exit_bar = na

var float stored_sell_entry = na
var float stored_sell_sl = na
var float stored_sell_tp1 = na
var float stored_sell_tp2 = na
var int stored_sell_bar = na
var float stored_sell_high_for_label = na
var int stored_sell_exit_bar = na

var string active_trade_id = na

// Track signal bars
var array<int> signal_bars = array.new_int(0)

// Signal triggered flags
var bool buy_triggered_flag = false
var bool sell_triggered_flag = false

if crossover_30
    buy_triggered_flag := false
if crossover_70
    sell_triggered_flag := false

// === DRAWING ARRAYS - For active trade only ===
var line[] active_lines = array.new_line()
var label[] active_labels = array.new_label()
var box[] active_boxes = array.new_box()
var linefill[] active_fills = array.new_linefill()

f_clear_all() =>
    for l in active_lines
        line.delete(l)
    for lb in active_labels
        label.delete(lb)
    for b in active_boxes
        box.delete(b)
    for f in active_fills
        linefill.delete(f)
    array.clear(active_lines)
    array.clear(active_labels)
    array.clear(active_boxes)
    array.clear(active_fills)

f_get_market() =>
    syminfo.type == "forex" ? "Forex" : syminfo.type == "crypto" ? "Crypto" : syminfo.type == "futures" ? "Futures" : syminfo.type == "index" ? "Indices" : syminfo.type == "cfd" ? "Metals" : syminfo.type == "stock" ? "Stocks" : "Unknown"

// === WIN RATE ===
var int buy_wins = 0
var int buy_losses = 0
var int sell_wins = 0
var int sell_losses = 0

f_pct(v) => str.tostring(v, "#.##") + "%"

// === ATR ===
atr_v = ta.atr(atr_len_input)
label_offset = atr_v * atr_offset_mult

// ============================================
// SIGNAL CONDITIONS
// ============================================

prev_close = close[1]
prev_open = open[1]
prev_high = high[1]
prev_low = low[1]
prev_body = math.abs(prev_close - prev_open)
prev_range = prev_high - prev_low
prev_ratio = prev_range > 0 ? prev_body / prev_range : 0

highest_filter = ta.highest(high[2], filter_lookback)
lowest_filter = ta.lowest(low[2], filter_lookback)

buy_conditions = buy_allowed and
     not buy_triggered_flag and
     recent_cross_30 and
     not na(buy_fractal_level) and
     not na(lowest_low) and
     (buy_fractal_level - lowest_low) > 0 and
     prev_close > buy_fractal_level and
     prev_close > prev_open and
     prev_ratio > 0.5 and
     prev_close > highest_filter and
     htf_buy_ok and
     not signal_lock

buy_pot_tp1 = buy_fractal_level + (buy_fractal_level - lowest_low)
buy_tp1_valid = na(buy_pot_tp1) ? true : prev_high < buy_pot_tp1

sell_conditions = sell_allowed and
     not sell_triggered_flag and
     recent_cross_70 and
     not na(sell_fractal_level) and
     not na(highest_high) and
     (highest_high - sell_fractal_level) > 0 and
     prev_close < sell_fractal_level and
     prev_close < prev_open and
     prev_ratio > 0.5 and
     prev_close < lowest_filter and
     htf_sell_ok and
     not signal_lock

sell_pot_tp1 = sell_fractal_level - (highest_high - sell_fractal_level)
sell_tp1_valid = na(sell_pot_tp1) ? true : prev_low > sell_pot_tp1

bool buy_signal = buy_conditions and buy_tp1_valid and barstate.isconfirmed
bool sell_signal = sell_conditions and sell_tp1_valid and barstate.isconfirmed

// ============================================
// CHECK EXITS FIRST - Create PERMANENT lines when exit happens
// ============================================
if is_buy_active and not na(stored_buy_entry) and barstate.isconfirmed and na(stored_buy_exit_bar)
    if low <= stored_buy_sl
        buy_losses += 1
        stored_buy_exit_bar := bar_index
        
        // Create PERMANENT lines to exit bar
        l_sl_perm = line.new(stored_buy_bar, stored_buy_sl, stored_buy_exit_bar, stored_buy_sl, 
                 color=color.new(c_sell_main, 20), width=1, extend=extend.none)
        l_entry_perm = line.new(stored_buy_bar, stored_buy_entry, stored_buy_exit_bar, stored_buy_entry, 
                 color=color.new(c_buy_main, 20), width=1, extend=extend.none)
        l_tp2_perm = line.new(stored_buy_bar, stored_buy_tp2, stored_buy_exit_bar, stored_buy_tp2, 
                 color=color.new(c_buy_main, 40), width=1, style=line.style_dashed, extend=extend.none)
        box.new(stored_buy_bar, stored_buy_entry, stored_buy_exit_bar, stored_buy_sl, border_color=color.new(c_buy_main, 80), bgcolor=color.new(c_buy_main, 92))
        
        // Create PERMANENT linefills
        if show_line_fill_active
            linefill.new(l_sl_perm, l_entry_perm, color.new(c_sell_main, 95))
            linefill.new(l_entry_perm, l_tp2_perm, color.new(c_buy_main, 95))
        
        alert('{"secret":"quantio_tv_9f2a7c8d91a34b","event":"SL","trade_id":"' + active_trade_id + '"}', alert.freq_once_per_bar_close)
        label.new(bar_index, stored_buy_sl, "LOSS", color=c_loss, textcolor=color.white, style=label.style_label_up, size=size.tiny)
        
        is_buy_active := false
        signal_lock := false
        stored_buy_entry := na
        f_clear_all()
        
    else if high >= stored_buy_tp2
        buy_wins += 1
        stored_buy_exit_bar := bar_index
        
        // Create PERMANENT lines to exit bar
        l_sl_perm = line.new(stored_buy_bar, stored_buy_sl, stored_buy_exit_bar, stored_buy_sl, 
                 color=color.new(c_sell_main, 20), width=1, extend=extend.none)
        l_entry_perm = line.new(stored_buy_bar, stored_buy_entry, stored_buy_exit_bar, stored_buy_entry, 
                 color=color.new(c_buy_main, 20), width=1, extend=extend.none)
        l_tp2_perm = line.new(stored_buy_bar, stored_buy_tp2, stored_buy_exit_bar, stored_buy_tp2, 
                 color=color.new(c_buy_main, 40), width=1, style=line.style_dashed, extend=extend.none)
        box.new(stored_buy_bar, stored_buy_entry, stored_buy_exit_bar, stored_buy_sl, border_color=color.new(c_buy_main, 80), bgcolor=color.new(c_buy_main, 92))
        
        // Create PERMANENT linefills
        if show_line_fill_active
            linefill.new(l_sl_perm, l_entry_perm, color.new(c_sell_main, 95))
            linefill.new(l_entry_perm, l_tp2_perm, color.new(c_buy_main, 95))
        
        alert('{"secret":"quantio_tv_9f2a7c8d91a34b","event":"TP2","trade_id":"' + active_trade_id + '"}', alert.freq_once_per_bar_close)
        label.new(bar_index, stored_buy_tp2, "WIN", color=c_win, textcolor=color.white, style=label.style_label_down, size=size.tiny)
        
        is_buy_active := false
        signal_lock := false
        stored_buy_entry := na
        f_clear_all()

if is_sell_active and not na(stored_sell_entry) and barstate.isconfirmed and na(stored_sell_exit_bar)
    if high >= stored_sell_sl
        sell_losses += 1
        stored_sell_exit_bar := bar_index
        
        // Create PERMANENT lines to exit bar
        l_sl_perm = line.new(stored_sell_bar, stored_sell_sl, stored_sell_exit_bar, stored_sell_sl, 
                 color=color.new(c_sell_main, 20), width=1, extend=extend.none)
        l_entry_perm = line.new(stored_sell_bar, stored_sell_entry, stored_sell_exit_bar, stored_sell_entry, 
                 color=color.new(c_sell_main, 20), width=1, extend=extend.none)
        l_tp2_perm = line.new(stored_sell_bar, stored_sell_tp2, stored_sell_exit_bar, stored_sell_tp2, 
                 color=color.new(c_sell_main, 40), width=1, style=line.style_dashed, extend=extend.none)
        box.new(stored_sell_bar, stored_sell_sl, stored_sell_exit_bar, stored_sell_entry, border_color=color.new(c_sell_main, 80), bgcolor=color.new(c_sell_main, 92))
        
        // Create PERMANENT linefills
        if show_line_fill_active
            linefill.new(l_sl_perm, l_entry_perm, color.new(c_sell_main, 95))
            linefill.new(l_entry_perm, l_tp2_perm, color.new(c_sell_main, 95))
        
        alert('{"secret":"quantio_tv_9f2a7c8d91a34b","event":"SL","trade_id":"' + active_trade_id + '"}', alert.freq_once_per_bar_close)
        label.new(bar_index, stored_sell_sl, "LOSS", color=c_loss, textcolor=color.white, style=label.style_label_down, size=size.tiny)
        
        is_sell_active := false
        signal_lock := false
        stored_sell_entry := na
        f_clear_all()
        
    else if low <= stored_sell_tp2
        sell_wins += 1
        stored_sell_exit_bar := bar_index
        
        // Create PERMANENT lines to exit bar
        l_sl_perm = line.new(stored_sell_bar, stored_sell_sl, stored_sell_exit_bar, stored_sell_sl, 
                 color=color.new(c_sell_main, 20), width=1, extend=extend.none)
        l_entry_perm = line.new(stored_sell_bar, stored_sell_entry, stored_sell_exit_bar, stored_sell_entry, 
                 color=color.new(c_sell_main, 20), width=1, extend=extend.none)
        l_tp2_perm = line.new(stored_sell_bar, stored_sell_tp2, stored_sell_exit_bar, stored_sell_tp2, 
                 color=color.new(c_sell_main, 40), width=1, style=line.style_dashed, extend=extend.none)
        box.new(stored_sell_bar, stored_sell_sl, stored_sell_exit_bar, stored_sell_entry, border_color=color.new(c_sell_main, 80), bgcolor=color.new(c_sell_main, 92))
        
        // Create PERMANENT linefills
        if show_line_fill_active
            linefill.new(l_sl_perm, l_entry_perm, color.new(c_sell_main, 95))
            linefill.new(l_entry_perm, l_tp2_perm, color.new(c_sell_main, 95))
        
        alert('{"secret":"quantio_tv_9f2a7c8d91a34b","event":"TP2","trade_id":"' + active_trade_id + '"}', alert.freq_once_per_bar_close)
        label.new(bar_index, stored_sell_tp2, "WIN", color=c_win, textcolor=color.white, style=label.style_label_up, size=size.tiny)
        
        is_sell_active := false
        signal_lock := false
        stored_sell_entry := na
        f_clear_all()

// ============================================
// BUY SIGNAL EXECUTION
// ============================================
if buy_signal
    stored_buy_entry := buy_fractal_level
    stored_buy_sl := lowest_low
    box_dist = stored_buy_entry - stored_buy_sl
    stored_buy_tp1 := stored_buy_entry + box_dist
    stored_buy_tp2 := stored_buy_entry + 2 * box_dist
    stored_buy_bar := bar_index - 1
    stored_buy_low_for_label := prev_low
    stored_buy_exit_bar := na
    
    array.push(signal_bars, bar_index)
    
    is_buy_active := true
    signal_lock := true
    buy_triggered_flag := true
    
    if is_sell_active
        f_clear_all()
        is_sell_active := false
    
    market = f_get_market()
    active_trade_id := syminfo.ticker + "_" + timeframe.period + "_" + str.tostring(time)
    
    alert('{"secret":"quantio_tv_9f2a7c8d91a34b","event":"OPEN","trade_id":"' + active_trade_id + '","symbol":"' + syminfo.ticker + '","market":"' + market + '","side":"buy","entry":' + str.tostring(stored_buy_entry) + ',"tp1":' + str.tostring(stored_buy_tp1) + ',"tp2":' + str.tostring(stored_buy_tp2) + ',"sl":' + str.tostring(stored_buy_sl) + ',"timeframe":"' + timeframe.period + '"}', alert.freq_once_per_bar_close)

// ============================================
// SELL SIGNAL EXECUTION
// ============================================
if sell_signal
    stored_sell_entry := sell_fractal_level
    stored_sell_sl := highest_high
    box_dist = stored_sell_sl - stored_sell_entry
    stored_sell_tp1 := stored_sell_entry - box_dist
    stored_sell_tp2 := stored_sell_entry - 2 * box_dist
    stored_sell_bar := bar_index - 1
    stored_sell_high_for_label := prev_high
    stored_sell_exit_bar := na
    
    array.push(signal_bars, bar_index)
    
    is_sell_active := true
    signal_lock := true
    sell_triggered_flag := true
    
    if is_buy_active
        f_clear_all()
        is_buy_active := false
    
    market = f_get_market()
    active_trade_id := syminfo.ticker + "_" + timeframe.period + "_" + str.tostring(time)
    
    alert('{"secret":"quantio_tv_9f2a7c8d91a34b","event":"OPEN","trade_id":"' + active_trade_id + '","symbol":"' + syminfo.ticker + '","market":"' + market + '","side":"sell","entry":' + str.tostring(stored_sell_entry) + ',"tp1":' + str.tostring(stored_sell_tp1) + ',"tp2":' + str.tostring(stored_sell_tp2) + ',"sl":' + str.tostring(stored_sell_sl) + ',"timeframe":"' + timeframe.period + '"}', alert.freq_once_per_bar_close)

// ============================================
// DRAWING SYSTEM - ONLY for ACTIVE trades
// Closed trades have permanent lines already created at exit
// ============================================

// BUY trade drawing - ONLY if active
if is_buy_active and not na(stored_buy_entry)
    f_clear_all()
    
    line_end = bar_index + x
    dist_sl = math.abs(stored_buy_entry - stored_buy_sl)
    dist_tp2 = math.abs(stored_buy_entry - stored_buy_tp2)
    ratio = dist_sl > 0 ? dist_tp2 / dist_sl : 0
    total_buy = buy_wins + buy_losses
    wr = total_buy > 0 ? (buy_wins / total_buy) * 100 : 0
    
    // PERMANENT elements at signal bar (created once)
    if bar_index == stored_buy_bar + 1
        box.new(stored_buy_bar, stored_buy_entry, stored_buy_bar + 1, stored_buy_sl, border_color=color.new(c_buy_main, 80), bgcolor=color.new(c_buy_main, 95))
        line.new(stored_buy_bar, stored_buy_sl, stored_buy_bar + 1, stored_buy_sl, 
                 color=color.new(c_buy_main, 30), width=persistent_line_width)
        line.new(stored_buy_bar, stored_buy_entry, stored_buy_bar + 1, stored_buy_entry, 
                 color=color.new(c_buy_main, 30), width=persistent_line_width)
        label.new(stored_buy_bar, stored_buy_low_for_label - label_offset, "BUY", 
                  style=label.style_label_up, color=c_buy_main, textcolor=color.white, size=signal_label_size)
    
    // ACTIVE extending elements (deleted and recreated each bar)
    active_box = box.new(stored_buy_bar, stored_buy_entry, line_end, stored_buy_sl, 
                         border_color=color.new(c_buy_main, 80), bgcolor=color.new(c_buy_main, 92))
    array.push(active_boxes, active_box)
    
    l_sl = line.new(stored_buy_bar, stored_buy_sl, line_end, stored_buy_sl, color=color.new(c_sell_main, 20), width=1)
    l_entry = line.new(stored_buy_bar, stored_buy_entry, line_end, stored_buy_entry, 
                       color=color.new(c_buy_main, 20), width=1)
    l_tp2 = line.new(stored_buy_bar, stored_buy_tp2, line_end, stored_buy_tp2, 
                     color=color.new(c_buy_main, 40), style=line.style_dashed, width=1)
    array.push(active_lines, l_sl)
    array.push(active_lines, l_entry)
    array.push(active_lines, l_tp2)
    
    lb_sl = label.new(line_end, stored_buy_sl, "SL " + str.tostring(stored_buy_sl, format.mintick), 
                      color=c_sell_main, textcolor=color.white, style=label.style_label_left, size=size.small)
    lb_entry = label.new(line_end, stored_buy_entry, "Entry " + str.tostring(stored_buy_entry, format.mintick) + " (Ratio: " + str.tostring(ratio, "#.#") + ")", 
                         color=c_buy_main, textcolor=color.white, style=label.style_label_left, size=size.small)
    lb_tp2 = label.new(line_end, stored_buy_tp2, "TP2 " + str.tostring(stored_buy_tp2, format.mintick) + " (" + f_pct(wr) + ")", 
                       color=c_buy_main, textcolor=color.white, style=label.style_label_left, size=size.small)
    array.push(active_labels, lb_sl)
    array.push(active_labels, lb_entry)
    array.push(active_labels, lb_tp2)
    
    if show_line_fill_active
        f1 = linefill.new(l_sl, l_entry, color.new(c_sell_main, 95))
        f2 = linefill.new(l_entry, l_tp2, color.new(c_buy_main, 95))
        array.push(active_fills, f1)
        array.push(active_fills, f2)

// SELL trade drawing - ONLY if active
if is_sell_active and not na(stored_sell_entry)
    f_clear_all()
    
    line_end = bar_index + x
    dist_sl = math.abs(stored_sell_sl - stored_sell_entry)
    dist_tp2 = math.abs(stored_sell_entry - stored_sell_tp2)
    ratio = dist_sl > 0 ? dist_tp2 / dist_sl : 0
    total_sell = sell_wins + sell_losses
    wr = total_sell > 0 ? (sell_wins / total_sell) * 100 : 0
    
    if bar_index == stored_sell_bar + 1
        box.new(stored_sell_bar, stored_sell_sl, stored_sell_bar + 1, stored_sell_entry, border_color=color.new(c_sell_main, 80), bgcolor=color.new(c_sell_main, 95))
        line.new(stored_sell_bar, stored_sell_sl, stored_sell_bar + 1, stored_sell_sl, 
                 color=color.new(c_sell_main, 30), width=persistent_line_width)
        line.new(stored_sell_bar, stored_sell_entry, stored_sell_bar + 1, stored_sell_entry, 
                 color=color.new(c_sell_main, 30), width=persistent_line_width)
        label.new(stored_sell_bar, stored_sell_high_for_label + label_offset, "SELL", 
                  style=label.style_label_down, color=c_sell_main, textcolor=color.white, size=signal_label_size)
    
    active_box = box.new(stored_sell_bar, stored_sell_sl, line_end, stored_sell_entry, 
                         border_color=color.new(c_sell_main, 80), bgcolor=color.new(c_sell_main, 92))
    array.push(active_boxes, active_box)
    
    l_sl = line.new(stored_sell_bar, stored_sell_sl, line_end, stored_sell_sl, color=color.new(c_sell_main, 20), width=1)
    l_entry = line.new(stored_sell_bar, stored_sell_entry, line_end, stored_sell_entry, 
                       color=color.new(c_sell_main, 20), width=1)
    l_tp2 = line.new(stored_sell_bar, stored_sell_tp2, line_end, stored_sell_tp2, 
                     color=color.new(c_sell_main, 40), style=line.style_dashed, width=1)
    array.push(active_lines, l_sl)
    array.push(active_lines, l_entry)
    array.push(active_lines, l_tp2)
    
    lb_sl = label.new(line_end, stored_sell_sl, "SL " + str.tostring(stored_sell_sl, format.mintick), 
                      color=c_sell_main, textcolor=color.white, style=label.style_label_left, size=size.small)
    lb_entry = label.new(line_end, stored_sell_entry, "Entry " + str.tostring(stored_sell_entry, format.mintick) + " (Ratio: " + str.tostring(ratio, "#.#") + ")", 
                         color=c_sell_main, textcolor=color.white, style=label.style_label_left, size=size.small)
    lb_tp2 = label.new(line_end, stored_sell_tp2, "TP2 " + str.tostring(stored_sell_tp2, format.mintick) + " (" + f_pct(wr) + ")", 
                       color=c_sell_main, textcolor=color.white, style=label.style_label_left, size=size.small)
    array.push(active_labels, lb_sl)
    array.push(active_labels, lb_entry)
    array.push(active_labels, lb_tp2)
    
    if show_line_fill_active
        f1 = linefill.new(l_sl, l_entry, color.new(c_sell_main, 95))
        f2 = linefill.new(l_entry, l_tp2, color.new(c_sell_main, 95))
        array.push(active_fills, f1)
        array.push(active_fills, f2)

// ============================================
// CANDLE COLORING
// ============================================
is_signal_bar = false
if array.size(signal_bars) > 0
    for i = 0 to array.size(signal_bars) - 1
        if bar_index == array.get(signal_bars, i)
            is_signal_bar := true
            break

color candle_col = na
if is_signal_bar
    candle_col := c_signal_bar
else if is_buy_active
    candle_col := c_buy_main
else if is_sell_active
    candle_col := c_sell_main
else if enable_grey_candles
    candle_col := c_candle_neutral
else
    candle_col := close >= open ? #089981 : #F23645

plotcandle(open, high, low, close, color=candle_col, wickcolor=candle_col, bordercolor=candle_col)
barcolor(is_signal_bar ? c_signal_bar : na)

// ============================================
// DASHBOARDS
// ============================================
f_dash_col(is_b, is_s) =>
    bg = is_b ? color.new(c_buy_main, 80) : is_s ? color.new(c_sell_main, 80) : c_text_dark
    txt = is_b ? c_buy_main : is_s ? c_sell_main : color.gray
    [bg, txt]

if not backtesting_mode
    m1_b = nz(request.security(syminfo.tickerid, "1", is_buy_active[1], lookahead=barmerge.lookahead_off), false)
    m1_s = nz(request.security(syminfo.tickerid, "1", is_sell_active[1], lookahead=barmerge.lookahead_off), false)
    m5_b = nz(request.security(syminfo.tickerid, "5", is_buy_active[1], lookahead=barmerge.lookahead_off), false)
    m5_s = nz(request.security(syminfo.tickerid, "5", is_sell_active[1], lookahead=barmerge.lookahead_off), false)
    m15_b = nz(request.security(syminfo.tickerid, "15", is_buy_active[1], lookahead=barmerge.lookahead_off), false)
    m15_s = nz(request.security(syminfo.tickerid, "15", is_sell_active[1], lookahead=barmerge.lookahead_off), false)
    m30_b = nz(request.security(syminfo.tickerid, "30", is_buy_active[1], lookahead=barmerge.lookahead_off), false)
    m30_s = nz(request.security(syminfo.tickerid, "30", is_sell_active[1], lookahead=barmerge.lookahead_off), false)
    h1_b = nz(request.security(syminfo.tickerid, "60", is_buy_active[1], lookahead=barmerge.lookahead_off), false)
    h1_s = nz(request.security(syminfo.tickerid, "60", is_sell_active[1], lookahead=barmerge.lookahead_off), false)
    h4_b = nz(request.security(syminfo.tickerid, "240", is_buy_active[1], lookahead=barmerge.lookahead_off), false)
    h4_s = nz(request.security(syminfo.tickerid, "240", is_sell_active[1], lookahead=barmerge.lookahead_off), false)
    d1_b = nz(request.security(syminfo.tickerid, "D", is_buy_active[1], lookahead=barmerge.lookahead_off), false)
    d1_s = nz(request.security(syminfo.tickerid, "D", is_sell_active[1], lookahead=barmerge.lookahead_off), false)

    var table mtf = table.new(position.top_right, 7, 1, border_width=1, border_color=color.new(color.gray, 80), bgcolor=c_text_dark)
    if barstate.islast
        [bg1, t1] = f_dash_col(m1_b, m1_s)
        table.cell(mtf, 0, 0, "M1", bgcolor=bg1, text_color=t1, text_size=size.small)
        [bg5, t5] = f_dash_col(m5_b, m5_s)
        table.cell(mtf, 1, 0, "M5", bgcolor=bg5, text_color=t5, text_size=size.small)
        [bg15, t15] = f_dash_col(m15_b, m15_s)
        table.cell(mtf, 2, 0, "M15", bgcolor=bg15, text_color=t15, text_size=size.small)
        [bg30, t30] = f_dash_col(m30_b, m30_s)
        table.cell(mtf, 3, 0, "M30", bgcolor=bg30, text_color=t30, text_size=size.small)
        [bgh1, th1] = f_dash_col(h1_b, h1_s)
        table.cell(mtf, 4, 0, "H1", bgcolor=bgh1, text_color=th1, text_size=size.small)
        [bgh4, th4] = f_dash_col(h4_b, h4_s)
        table.cell(mtf, 5, 0, "H4", bgcolor=bgh4, text_color=th4, text_size=size.small)
        [bgd1, td1] = f_dash_col(d1_b, d1_s)
        table.cell(mtf, 6, 0, "D1", bgcolor=bgd1, text_color=td1, text_size=size.small)

var table stats = table.new(position.bottom_right, 3, 3, border_width=1, border_color=color.new(color.gray, 90), bgcolor=c_text_dark)
if barstate.islast
    tot_b = buy_wins + buy_losses
    tot_s = sell_wins + sell_losses
    wr_b = tot_b > 0 ? (buy_wins / tot_b) * 100 : 0
    wr_s = tot_s > 0 ? (sell_wins / tot_s) * 100 : 0
    if signal_filter == "All Signals"
        table.cell(stats, 1, 0, "BUY", bgcolor=color.new(c_buy_main, 80), text_color=c_buy_main, text_size=size.small)
        table.cell(stats, 2, 0, "SELL", bgcolor=color.new(c_sell_main, 80), text_color=c_sell_main, text_size=size.small)
        table.cell(stats, 0, 2, "TP Prob.", text_color=color.gray, text_halign=text.align_left, text_size=size.small)
        table.cell(stats, 1, 2, f_pct(wr_b), text_color=color.white, text_size=size.small)
        table.cell(stats, 2, 2, f_pct(wr_s), text_color=color.white, text_size=size.small)
    else if signal_filter == "BUY Only"
        table.cell(stats, 1, 0, "BUY", bgcolor=color.new(c_buy_main, 80), text_color=c_buy_main, text_size=size.small)
        table.cell(stats, 0, 2, "TP Prob.", text_color=color.gray, text_halign=text.align_left, text_size=size.small)
        table.cell(stats, 1, 2, f_pct(wr_b), text_color=color.white, text_size=size.small)
    else
        table.cell(stats, 1, 0, "SELL", bgcolor=color.new(c_sell_main, 80), text_color=c_sell_main, text_size=size.small)
        table.cell(stats, 0, 2, "TP Prob.", text_color=color.gray, text_halign=text.align_left, text_size=size.small)
        table.cell(stats, 1, 2, f_pct(wr_s), text_color=color.white, text_size=size.small)
